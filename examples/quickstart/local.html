<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="../../dist/TangleBluetoothDevice.iife.js"></script>
  <script src="../../dist/TangleDevice.iife.js"></script>
  <link rel="stylesheet" href="style.css" />

  <title>Tangle Example</title>
</head>

<body>
  <button id="connect">Connect</button>
  <input type="color" value="#ffffff" id="color" />
  <button id="upload">Upload</button>
  <div class="">

    <button id="r">R</button>
    <button id="g">G</button>
    <button id="b">B</button>
  </div>
  <div class="">
    <button id="reset">RESET</button>

  </div>

  <script>
    // function uint8() {
    //   return `0x${parseInt(device.brightness).toString(16).padStart(2, "0")}`
    // }

    const tangleBluetoothDevice = new TangleBluetoothDevice();
    const tangleDevice = TangleDevice({ ble: tangleBluetoothDevice });

    const connectButton = document.querySelector("#connect");
    const colorInput = document.querySelector("#color");

    connectButton.onclick = () => {
      tangleDevice.connect();

      // Events for bluetooth connection and disconnect
      tangleBluetoothDevice.bluetoothConnection.addEventListener("disconnected", (_) => {
        connectButton.textContent = "Connect";
        connectButton.classList.remove("danger");
      });
      tangleBluetoothDevice.bluetoothConnection.addEventListener("connected", (_) => {
        connectButton.textContent = "Disconnect";
        connectButton.classList.add("danger");
      });
    };

    document.querySelector("#upload").onclick = () => {
      if (window.tangleConnect ?? tangleBluetoothDevice.bluetoothConnection.connected) {
        // Tangle run this effect for 15s
        const time = 1000 * 15;

        // User selected color value
        const selectedColor = colorInput.value;

        // Code we generated via Tangle Blockly
        // const code = `defDevice4("device1", 0x00, 0x40, 0x01, 10, 0, 0, 0);addDrawing(0, ${time}, animFill(${time}, ${selectedColor}););`;
        const code = `
        defDevice4("device1", 0x00, 0x40, 0x01, 15, 0, 0, 0);

        // Blockly vysila eventy pri keypressu klaves
        // Q,W,E,R,A,S,D,F,Y,X,C,V,Z
        // (bud s capslockem, nebo shiftem)
        // event code je ascii hodnota klavesy
        // parametr je vzdy 0

        // RED pri stisku Q (code = 81)
        onEvent(0x51)->emitEvent(0x00);
        // GREEN pri stisku W (code = 87)
        onEvent(0x57)->setEventParam(0xff)->emitEvent(0x01);
        // BLUE pri stisku E (code = 69)
        onEvent(0x45)->setEventParam(0xff)->emitEvent(0x02);
        // RESET pri stisku R (code = 82)
        onEvent(0x52)->setEventParam(0x00)->emitEvent(0x00);
        onEvent(0x52)->setEventParam(0x00)->emitEvent(0x01);
        onEvent(0x52)->setEventParam(0x00)->emitEvent(0x02);

        onEvent(0x46)->setEventParam(0x00)->emitEvent(0x00);

        writeChannel(0x00, eventParameterValueSmoothed(0x00, 1000));
        writeChannel(0x01, eventParameterValueSmoothed(0x01, 1000));
        writeChannel(0x02, eventParameterValueSmoothed(0x02, 1000));

        addWindow(0, 2147483647, {
          addDrawing(0, 2147483647, animColorRoll(1000, #00ff00, #003600));
        }).modifyBrightness(channel(0x00));
        addWindow(0, 2147483647, {
          addDrawing(0, 2147483647, animColorRoll(1000, #ff0000, #360000));
        }).modifyBrightness(channel(0x01));
        addWindow(0, 2147483647, {
          addDrawing(0, 2147483647, animColorRoll(1000, #0000ff, #000036));
        }).modifyBrightness(channel(0x02));
        // Strobo efekt pri resetu
        eventHandler(0, 2147483647, 0x52, 0x00, {
          subDrawing(0, 1000, animFill(50, #ffffff).animFill(50, #000000));
        });
        `
        // Uploads code to tangle device
        tangleDevice.uploadTngl(code);
      } else {

        alert("You have to connect your device first.");
      }
    };

    const r = document.querySelector('#r');
    const g = document.querySelector('#g');
    const b = document.querySelector('#b');
    const reset = document.querySelector('#reset');

    r.onclick = () => {
      tangleDevice.emitEvent('q', Math.floor(Math.random() * 50))
    }
    g.onclick = () => {
      tangleDevice.emitEvent('w', 0)
    }
    b.onclick = () => {
      tangleDevice.emitEvent('e', 0)
    }
    reset.onclick = () => {
      tangleDevice.emitEvent('r', 0)
    }
  </script>
</body>

</html>